<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .login-form {
        background: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .chat-container {
        display: none;
      }
      .messages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background: #f9f9f9;
      }
      .typing-indicator {
        padding: 5px 10px;
        color: #666;
        font-style: italic;
        min-height: 20px;
      }
      .input-group {
        display: flex;
        gap: 10px;
      }
      #messageInput {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        padding: 8px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <h1>Socket.io Test</h1>

    <!-- Login Form -->
    <div id="loginForm" class="login-form">
      <h3>Join Chat</h3>
      <div class="form-group">
        <label for="usernameInput">Username:</label>
        <input
          type="text"
          id="usernameInput"
          placeholder="Enter your username"
          value=""
        />
      </div>
      <div class="form-group">
        <label for="userIdInput">User ID (optional):</label>
        <input
          type="text"
          id="userIdInput"
          placeholder="Leave empty for auto-generated ID"
          value=""
        />
      </div>
      <button onclick="connectToChat()">Connect to Chat</button>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
      <div id="connectionStatus"></div>
      <div id="messages" class="messages"></div>
      <div id="typingIndicator" class="typing-indicator"></div>
      <div class="input-group">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          onkeypress="handleKeyPress(event)"
          oninput="handleTyping()"
        />
        <button onclick="sendMessage()">Send Message</button>
      </div>
    </div>

    <script>
      let socket = null;
      let currentUserId = null;
      let currentUsername = null;
      let typingTimer = null;
      let isTyping = false;
      let typingUsers = new Map(); // Changed to Map to store userId -> username

      // Generate a random user ID
      function generateUserId() {
        return "user_" + Math.random().toString(36).substr(2, 9);
      }

      // Generate a random username (fallback)
      function generateUsername() {
        const adjectives = [
          "Happy",
          "Cool",
          "Swift",
          "Bright",
          "Bold",
          "Quick",
          "Smart",
          "Brave",
        ];
        const nouns = [
          "Cat",
          "Dog",
          "Eagle",
          "Tiger",
          "Wolf",
          "Fox",
          "Bear",
          "Lion",
        ];
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        return adj + noun + Math.floor(Math.random() * 1000);
      }

      // Connect to chat
      function connectToChat() {
        const usernameInput = document
          .getElementById("usernameInput")
          .value.trim();
        const userIdInput = document.getElementById("userIdInput").value.trim();

        // Set username (use input or generate one)
        currentUsername = usernameInput || generateUsername();

        // Set user ID (use input or generate one)
        currentUserId = userIdInput || generateUserId();

        // Hide login form and show chat
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("chatContainer").style.display = "block";

        // Initialize socket connection
        initializeSocket();
      }

      function initializeSocket() {
        addMessage(
          `ðŸ”„ Connecting as ${currentUsername} (ID: ${currentUserId})...`
        );

        socket = io("http://localhost:3001", {
          query: {
            userId: currentUserId,
            username: currentUsername,
          },
        });

        socket.on("connect", () => {
          addMessage(
            `âœ… Connected as ${currentUsername} (ID: ${currentUserId})!`
          );

          // Join the general room after connecting
          socket.emit("joinRoom", "general");
          addMessage(`ðŸ“ Joining room: general`);
        });

        socket.on("disconnect", () => {
          addMessage(`âŒ Disconnected from server`);
        });

        socket.on("error", (error) => {
          addMessage(`âŒ Error: ${error}`);
          console.error("Socket error:", error);
        });

        socket.on("newMessage", (message) => {
          console.log(message);
          addMessage(
            `ðŸ’¬ <strong>${message.username}:</strong> ${message.content}`
          );
        });

        socket.on("userJoined", (data) => {
          addMessage(`ðŸ‘‹ ${data.username} joined the room`);
        });

        socket.on("userLeft", (data) => {
          addMessage(`ðŸ‘‹ ${data.username} left the room`);
        });

        // Listen for typing events
        socket.on("userTyping", (data) => {
          if (data.username !== currentUsername) {
            console.log(data.username)
            typingUsers.add(data.username);
            updateTypingIndicator();

            // Remove user from typing list after 3 seconds
            setTimeout(() => {
              typingUsers.delete(data.username);
              updateTypingIndicator();
            }, 3000);
          }
        });
      }

      // Update typing indicator display
      function updateTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingUsers.size === 0) {
          typingIndicator.textContent = "";
        } else if (typingUsers.size === 1) {
          typingIndicator.textContent = `${
            Array.from(typingUsers)[0]
          } is typing...`;
        } else if (typingUsers.size === 2) {
          typingIndicator.textContent = `${Array.from(typingUsers).join(
            " and "
          )} are typing...`;
        } else {
          typingIndicator.textContent = `${typingUsers.size} people are typing...`;
        }
      }

      // Handle typing events
      function handleTyping() {
        if (!isTyping) {
          isTyping = true;
          socket.emit("startTyping", "general");
        }

        // Clear existing timer
        clearTimeout(typingTimer);

        // Set a new timer to stop typing after 1 second of inactivity
        typingTimer = setTimeout(() => {
          isTyping = false;
        }, 1000);
      }

      // Add message to the chat display
      function addMessage(message) {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML += `<p>${message}</p>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Function to send message
      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();

        if (content && socket) {
          socket.emit("sendMessage", {
            content: content,
            roomId: "general",
          });
          messageInput.value = ""; // Clear the input

          // Reset typing state
          if (isTyping) {
            isTyping = false;
            socket.emit("stopTyping", "general");
          }
          clearTimeout(typingTimer);
        }
      }

      // Handle Enter key press in message input
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      // Set random default values on page load
      window.onload = function () {
        document.getElementById("usernameInput").value = generateUsername();
        document.getElementById("userIdInput").value = generateUserId();
      };
    </script>
  </body>
</html>
